
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>句子排列遊戲</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "pinyin-pro": "https://esm.sh/pinyin-pro@3.7.0",
        "lodash/shuffle": "https://esm.sh/lodash.shuffle@4.2.0",
        "sortablejs": "https://esm.sh/sortablejs@1.15.0"
      }
    }
  </script>
</head>
<body class="bg-sky-50 text-slate-900 antialiased">
  <div id="root" class="p-6 max-w-3xl mx-auto"></div>

  <script type="module">
    import React, { useState, useEffect } from 'react';
    import { createRoot } from 'react-dom/client';
    import { pinyin, customPinyin } from 'pinyin-pro';
    import shuffle from 'lodash/shuffle';
    import Sortable from 'sortablejs';

    const CUSTOM_PINYIN_HANS = {
      爸爸: 'bàba',
      子: 'zi',
      妈妈: 'māma',
      姐姐: 'jiějie',
      妹妹: 'mèimei',
      饺子: 'jiǎozi',
      奶奶: 'nǎinai',
      爷爷: 'yéye',
      弟弟: 'dìdi',
      哥哥: 'gēge',
      叔叔: 'shūshu',
      喜欢: 'xǐhuan',   // ← 簡體
      早上: 'zǎoshang', 
      晚上: 'wǎnshang',
      们: 'men',
    };

    const CUSTOM_PINYIN_HANT = {
      爸爸: 'bàba',
      子: 'zi',
      媽媽: 'māma',
      姐姐: 'jiějie',
      妹妹: 'mèimei',
      餃子: 'jiǎozi',
      奶奶: 'nǎinai',
      爺爺: 'yéye',
      弟弟: 'dìdi',
      哥哥: 'gēge',
      叔叔: 'shūshu', // ← 繁體
      們: 'men',
    };


    const correctAudio = new Audio('sounds/correct.mp3');
    const wrongAudio = new Audio('sounds/wrong.mp3');
    correctAudio.preload = 'auto';
    wrongAudio.preload = 'auto';
    correctAudio.load();
    wrongAudio.load();

    function unlockAudioOnce() {
    const tryUnlock = (a) => {
    try {
      const p = a.play();
      if (p && typeof p.then === 'function') {
        p.then(() => {
          a.pause();
          a.currentTime = 0;
        }).catch(() => {});
      } else {
        a.pause();
        a.currentTime = 0;
      }
       } catch (_) {}
     };
    tryUnlock(correctAudio);
    tryUnlock(wrongAudio);
    document.removeEventListener('pointerdown', unlockAudioOnce);
    document.removeEventListener('touchend', unlockAudioOnce);
}
    document.addEventListener('pointerdown', unlockAudioOnce, { once: true, passive: true });
    document.addEventListener('touchend', unlockAudioOnce, { once: true, passive: true });
    
    function Game() {
      const [lang, setLang] = useState('zh-Hant');
      const [voice, setVoice] = useState(null);
      const [availableVoices, setAvailableVoices] = useState([]);
      const [questions, setQuestions] = useState([]);
      const [originalQuestions, setOriginalQuestions] = useState([]);
      const [currentIndex, setCurrentIndex] = useState(0);
      const [mode, setMode] = useState('pinyin');
      const [gameStarted, setGameStarted] = useState(false);
      const [startTime, setStartTime] = useState(null);
      const [elapsed, setElapsed] = useState(0);
      const [errorCount, setErrorCount] = useState(0);
      const [correctCount, setCorrectCount] = useState(0);
      const [finished, setFinished] = useState(false);
      const [inputRaw, setInputRaw] = useState('他/不是/孩子\n我/是/老師\n我/是/學生');
      const [zhuyinCache, setZhuyinCache] = useState({});
      const [pendingVoiceName, setPendingVoiceName] = useState(null);
      const hasStartedRef = React.useRef(false);

      const texts = {
        'labelLanguage': { 'zh-Hant': '語言', 'zh-Hans': '语言' },
        'labelVoice':    { 'zh-Hant': '語音', 'zh-Hans': '语音' },
        'start': { 'zh-Hant': '開始遊戲', 'zh-Hans': '开始游戏' },
        'title': { 'zh-Hant': '句子排列 🐥🐥🐥', 'zh-Hans': '句子排列 🐥🐥🐥' },
        'completed': { 'zh-Hant': '🎉 全部完成！', 'zh-Hans': '🎉 全部完成！' },
        'totalTime': { 'zh-Hant': '總時間', 'zh-Hans': '总时间' },
        'questionsDone': { 'zh-Hant': '完成題數', 'zh-Hans': '完成题数' },
        'errors': { 'zh-Hant': '錯誤次數', 'zh-Hans': '错误次数' },
        'replay': { 'zh-Hant': '再玩一次', 'zh-Hans': '再玩一次' },
        'share': { 'zh-Hant': '分享遊戲', 'zh-Hans': '分享游戏' },
        'timeAndError': { 'zh-Hant': '時間', 'zh-Hans': '时间' },
        'errorCount': { 'zh-Hant': '錯誤', 'zh-Hans': '错误' },
        'questionPrefix': { 'zh-Hant': '第', 'zh-Hans': '第' },
        'questionSuffix': { 'zh-Hant': '題', 'zh-Hans': '题' },
        'totalPrefix': { 'zh-Hant': '共', 'zh-Hans': '共' },
        'totalSuffix': { 'zh-Hant': '題', 'zh-Hans': '题' },
      };

      useEffect(() => {
        if (lang === 'zh-Hans') {
          customPinyin(CUSTOM_PINYIN_HANS);
        } else {
          customPinyin(CUSTOM_PINYIN_HANT);
        }
      }, [lang]);

      useEffect(() => {
        const updateVoices = () => {
          const voices = window.speechSynthesis.getVoices();
          const chineseVoices = voices.filter(v => v.lang.startsWith('zh'));
          setAvailableVoices(chineseVoices);

          if (pendingVoiceName) {
            const matched = chineseVoices.find(v => v.name === pendingVoiceName);
            if (matched) {
              setVoice(matched);
              setPendingVoiceName(null);
              return;
            }
          }

          if (!voice && chineseVoices.length > 0) {
            setVoice(chineseVoices[0]);
          }
        };

        updateVoices();
        window.speechSynthesis.onvoiceschanged = updateVoices;
      }, [pendingVoiceName]);

      function speak(text) {
        const utterance = new SpeechSynthesisUtterance(text);
        if (voice) {
          utterance.voice = voice;
          utterance.lang = voice.lang || (lang === 'zh-Hant' ? 'zh-TW' : 'zh-CN');
        } else {
          utterance.lang = lang === 'zh-Hant' ? 'zh-TW' : 'zh-CN';
        }
        speechSynthesis.cancel();
        setTimeout(() => speechSynthesis.speak(utterance), 0);
      }

      const generateShareLink = () => {
        const payload = {
          questions,
          lang,
          mode,
          voiceName: voice?.name || null,
        };
        const url = `${window.location.origin}${window.location.pathname}?q=${encodeURIComponent(JSON.stringify(payload))}`;
        navigator.clipboard.writeText(url).then(() => alert('分享連結已複製！'));
      };

      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const encoded = params.get('q');
        if (!encoded) return;
        try {
          const parsed = JSON.parse(decodeURIComponent(encoded));
          if (parsed && typeof parsed === 'object' && Array.isArray(parsed.questions)) {
            setQuestions(parsed.questions);
            setOriginalQuestions(parsed.questions);
            if (parsed.lang) setLang(parsed.lang);
            if (parsed.mode) setMode(parsed.mode);
            if (parsed.voiceName) setPendingVoiceName(parsed.voiceName);
          } else if (Array.isArray(parsed)) {
            setQuestions(parsed);
            setOriginalQuestions(parsed);
          }
          setGameStarted(true);
          hasStartedRef.current = false;
          setStartTime(null);
          setElapsed(0);
          setErrorCount(0);
          setCorrectCount(0);
          setCurrentIndex(0);
          setFinished(false);
        } catch (err) {
          console.error('載入分享題庫失敗', err);
        }
      }, []);

      useEffect(() => {
        let timer;
        if (gameStarted && startTime && !finished) {
          timer = setInterval(() => {
            setElapsed(Math.floor((Date.now() - startTime) / 1000));
          }, 1000);
        }
        return () => { if (timer) clearInterval(timer); };
      }, [gameStarted, startTime, finished]);

      useEffect(() => {
        const current = questions[currentIndex] || [];
        if (!current.length) return;
        const optionZone = document.getElementById('option-zone');
        const answerZone = document.getElementById('answer-zone');

        optionZone.innerHTML = '';
        answerZone.innerHTML = '';
        const oldOpt = Sortable.get(optionZone); if (oldOpt) oldOpt.destroy();
        const oldAns = Sortable.get(answerZone); if (oldAns) oldAns.destroy();

        const zhuyinOverrides = {
          '爺爺和': 'ㄧㄝˊ ㄧㄝ˙ ㄏㄜˊ',
          '爺爺': 'ㄧㄝˊ ㄧㄝ˙ ',
          '爸爸': 'ㄅㄚˋ ㄅㄚ˙',
          '媽媽': 'ㄇㄚ˙ ㄇㄚ',
          '我': 'ㄨㄛˇ',
        };

        if (mode === 'zhuyin') {
          current.forEach(word => {
            if (!zhuyinCache[word]) {
              if (zhuyinOverrides[word]) {
                setZhuyinCache(prev => ({ ...prev, [word]: zhuyinOverrides[word] }));
                return;
              }
              fetch(`https://www.moedict.tw/uni/${encodeURIComponent(word)}.json`)
                .then(res => res.json())
                .then(data => {
                  const raw = data?.heteronyms?.[0]?.bopomofo || '';
                  const isValid = /^[\u3100-\u312F\u02CA\u02C7\u02CB\u02D9\s]+$/.test(raw);
                  if (isValid) {
                    setZhuyinCache(prev => ({ ...prev, [word]: raw }));
                  } else {
                    const chars = [...word];
                    const promises = chars.map(char =>
                      fetch(`https://www.moedict.tw/uni/${encodeURIComponent(char)}.json`)
                        .then(res => res.json())
                        .then(cdata => cdata?.heteronyms?.[0]?.bopomofo || '[無]')
                        .catch(() => '[錯誤]')
                    );
                    Promise.all(promises).then(results => {
                      const combined = results.join(' ');
                      setZhuyinCache(prev => ({ ...prev, [word]: combined }));
                    });
                  }
                })
                .catch(() => {
                  setZhuyinCache(prev => ({ ...prev, [word]: '[錯誤]' }));
                });
            }
          });
        }

        shuffle(current).forEach(word => {
          const div = document.createElement('div');
          div.className = 'min-w-[88px] px-3 py-2 border border-slate-200 rounded-xl bg-white text-center shadow-sm cursor-pointer hover:shadow transition-shadow focus:outline-none focus:ring-2 focus:ring-sky-400';
          div.setAttribute('data-word', word);
          div.innerHTML = `
            <div class="word text-xl sm:text-2xl font-bold leading-tight">${word}</div>
            <div class="text-sm sm:text-base text-gray-600 mt-0.5">${mode === 'pinyin' ? pinyin(word, { toneType: 'mark' }) : (zhuyinCache[word] || '查詢中...')}</div>
          `;
          optionZone.appendChild(div);
        });

        Sortable.create(optionZone, {
          group: 'shared',
          animation: 150,
          sort: false,
          onChoose: (evt) => {
            if (!hasStartedRef.current) {
              hasStartedRef.current = true;
              setStartTime(Date.now());
            }
            const dragged = evt.item?.getAttribute('data-word');
            if (dragged) speak(dragged);
          }
        });

        optionZone.addEventListener('click', () => {
          if (!hasStartedRef.current) {
            hasStartedRef.current = true;
            setStartTime(Date.now());
          }
        }, { once: true });

        Sortable.create(answerZone, {
          group: 'shared',
          animation: 150,
          onStart: () => {
            if (!hasStartedRef.current) {
              hasStartedRef.current = true;
              setStartTime(Date.now());
            }
          },
          onSort: () => {
            setTimeout(() => {
              const order = Array.from(answerZone.children).map(div => div.getAttribute('data-word'));
              const correct = current;
              const match = JSON.stringify(order) === JSON.stringify(correct);

              if (match && order.length === correct.length) {
                setCorrectCount(c => c + 1);
                if (currentIndex + 1 === questions.length) {
                  setFinished(true);
                  correctAudio.currentTime = 0;
                  correctAudio.play().catch(() => {});
                } else {
                  setCurrentIndex(i => i + 1);
                }
              } else if (order.length === correct.length) {
                wrongAudio.currentTime = 0;
                wrongAudio.play().catch(() => {});
                setErrorCount(c => c + 1);
                const wrongTiles = Array.from(answerZone.children);
                wrongTiles.forEach(tile => optionZone.appendChild(tile));
              }
            }, 0);
          }
        });

      }, [questions, currentIndex, mode, zhuyinCache, voice, lang]);

      const parseInput = () => {
        const lines = inputRaw.split('\n').map(line => line.trim()).filter(Boolean);
        const parsed = lines.map(line => line.split('/').map(s => s.trim()));
        const shuffled = shuffle(parsed);
        setQuestions(shuffled);
        setOriginalQuestions(parsed);
        setGameStarted(true);
        setElapsed(0);
        setErrorCount(0);
        setCorrectCount(0);
        setCurrentIndex(0);
        setFinished(false);
      };

      return (
        React.createElement('div', { className: 'bg-white/90 backdrop-blur rounded-2xl shadow-sm ring-1 ring-slate-200 p-4 sm:p-6' },
          // Header：標題 + 控制列
          React.createElement('header', { className: 'mb-4 space-y-3' },
            React.createElement('h1', { className: 'text-2xl font-bold text-gray-900 tracking-tight' }, texts.title[lang]),
            (!finished && React.createElement('div', { className: 'flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3' },
              // 左側：語言 + 語音
              React.createElement('div', { className: 'flex flex-wrap items-center gap-3' },
                React.createElement('label', { className: 'text-sm font-medium text-gray-700' }, `${texts.labelLanguage[lang]}：`),
                React.createElement('select', {
                  value: lang,
                  onChange: e => setLang(e.target.value),
                  className: 'border px-2 py-1 rounded bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-sky-400'
                },
                  React.createElement('option', { value: 'zh-Hant' }, '繁體中文'),
                  React.createElement('option', { value: 'zh-Hans' }, '简体中文')
                ),
                (availableVoices.length > 0) && React.createElement(React.Fragment, null,
                  React.createElement('label', { className: 'text-sm font-medium text-gray-700' }, `${texts.labelVoice[lang]}：`),
                  React.createElement('select', {
                    value: voice?.name,
                    onChange: e => {
                      const selected = availableVoices.find(v => v.name === e.target.value);
                      setVoice(selected);
                    },
                    className: 'border px-2 py-1 rounded bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-sky-400'
                  },
                    ...availableVoices.map(v =>
                      React.createElement('option', { key: v.name, value: v.name }, `${v.name} (${v.lang})`)
                    )
                  )
                )
              ),
              // 右側：拼音/注音切換
              React.createElement('div', { className: 'inline-flex rounded-lg overflow-hidden border' },
                React.createElement('button', {
                  onClick: () => setMode('pinyin'),
                  className: `px-3 py-1 text-sm ${mode === 'pinyin' ? 'bg-sky-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'}`
                }, '拼音'),
                React.createElement('button', {
                  onClick: () => setMode('zhuyin'),
                  className: `px-3 py-1 text-sm border-l ${mode === 'zhuyin' ? 'bg-sky-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'}`
                }, '注音')
              )
            ))
          ),

          // 主體
          !gameStarted ? (
            React.createElement('div', { className: 'space-y-3' },
              React.createElement('h2', { className: 'text-lg font-semibold text-gray-800' }, '輸入題目（每行一題，用 / 斷句）'),
              React.createElement('textarea', {
                className: 'w-full h-40 p-3 border rounded-lg bg-white text-gray-800 placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-sky-400',
                placeholder: '例如：我/是/老師',
                value: inputRaw,
                onChange: e => setInputRaw(e.target.value)
              }),
              React.createElement('div', { className: 'flex items-center justify-between' },
                React.createElement('span', { className: 'text-xs text-gray-500' }, '小技巧：用「Enter」換行新增下一題'),
                React.createElement('button', {
                  onClick: parseInput,
                  className: 'inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-sky-600 text-white hover:bg-sky-700 active:bg-sky-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-400'
                }, texts.start[lang])
              )
            )
          ) : finished ? (
            React.createElement('div', { className: 'text-center' },
              React.createElement('h2', { className: 'text-2xl font-bold mb-2' }, texts.completed[lang]),
              React.createElement('p', null, `${texts.totalTime[lang]}：${elapsed} 秒`),
              React.createElement('p', null, `${texts.questionsDone[lang]}：${correctCount}`),
              React.createElement('p', null, `${texts.errors[lang]}：${errorCount}`),
              React.createElement('div', { className: 'flex justify-center gap-2 mt-4' },
                React.createElement('button', {
                  className: 'px-4 py-2 rounded-lg bg-sky-600 text-white hover:bg-sky-700 active:bg-sky-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-400',
                  onClick: () => {
                    const shuffled = shuffle(originalQuestions);
                    setQuestions(shuffled);
                    setCurrentIndex(0);
                    setCorrectCount(0);
                    setErrorCount(0);
                    hasStartedRef.current = false;
                    setStartTime(null);
                    setElapsed(0);
                    setFinished(false);
                  }
                }, texts.replay[lang]),
                React.createElement('button', {
                  className: 'px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 active:bg-emerald-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-400',
                  onClick: generateShareLink
                }, texts.share[lang])
              )
            )
          ) : (
            React.createElement('div', null,
              // 頂部進度 + 計時/錯誤
              React.createElement('div', { className: 'mb-3' },
                React.createElement('div', { className: 'flex items-center justify-between text-sm text-gray-700' },
                  React.createElement('span', { className: 'font-medium' },
                    `${texts.questionPrefix[lang]} ${currentIndex + 1} ${texts.questionSuffix[lang]} / ${texts.totalPrefix[lang]} ${questions.length} ${texts.totalSuffix[lang]}`
                  ),
                  React.createElement('span', { className: 'text-gray-600', 'aria-live': 'polite' },
                    `${texts.timeAndError[lang]}：${elapsed}s　${texts.errorCount[lang]}：${errorCount}`
                  )
                ),
                React.createElement('div', { className: 'mt-2 h-2 w-full bg-slate-100 rounded-full overflow-hidden' },
                  React.createElement('div', {
                    className: 'h-full bg-sky-500 transition-[width] duration-300',
                    style: { width: `${(currentIndex / Math.max(questions.length, 1)) * 100}%` }
                  })
                )
              ),

              // 選項/答案區
              React.createElement('div', { className: 'grid grid-cols-1 gap-4' },
                React.createElement('div', null,
                  React.createElement('div', {
                    id: 'option-zone',
                    className: 'min-h-[96px] flex flex-wrap gap-2 border border-rose-200 p-2 bg-rose-50 rounded-lg'
                  })
                ),
                React.createElement('div', null,
                  React.createElement('h3', { className: 'text-sm mb-1 text-gray-600' }, '文を正しい順番に並べてください。'),
                  React.createElement('div', {
                    id: 'answer-zone',
                    className: 'min-h-[96px] flex flex-wrap gap-2 border border-slate-200 p-2 bg-white rounded-lg'
                  })
                )
              )
            )
          )
        )
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(React.createElement(Game));
  </script>
</body>
</html>
